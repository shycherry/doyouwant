<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="./dyw-crossword.html"/>

<dom-module name="dyw-crosswords">
  <style>
    :host{
      display: block;
      /*overflow: hidden;*/
      white-space: nowrap;
      position: relative;
      width: 500px;
      height: 100%;
    }
    ::content dyw-crossword {
      position: absolute;
    };
  </style>

  <template>
    <content id="crosswords" select="dyw-crossword"></content>
    <content id="crossmatchboxes" select="dyw-crossmatchbox"></content>
    <paper-toast duration=[[tipDuration]] text="test" id="tip"></paper-toast>
  </template>
</dom-module>

<script>
  Polymer({
    is: "dyw-crosswords",
    behaviors: [Polymer.IronResizableBehavior],
    properties:{
      tipDuration : {type:Number, value: 5000},
      caseSize : {type:Number,value: 100}
    },
    ready : function(){
      this.layoutChildren = this.layoutChildren.bind(this);

      this.addEventListener("iron-resize", this.layoutChildren);
      this.addEventListener("mouseover", function(ev){
        var currentNode = ev.toElement;
        if(currentNode.nodeName == "DYW-CROSSWORD"){
          currentNode.getFocus();
          this._focusedCrossword = currentNode;
          this.$.tip.text = currentNode.tip;
          this.$.tip.show();
        }
      });
      this.addEventListener("mouseout", function(ev){
        var currentNode = ev.fromElement;
        if(currentNode.nodeName == "DYW-CROSSWORD"){
          currentNode.lostFocus();
          this._focusedCrossword = null;
        }
      });
      this.addEventListener("dyw-crossword-resolution-changed", this.checkResolution);
    },
    checkResolution : function(){
      var crosswords = this.$.crosswords.getDistributedNodes();
      for(var idx = 0; idx < crosswords.length; idx++)
      {
        var currentCrossword = crosswords[idx];
        if(!currentCrossword.classList.contains("ok")){
          return;
        }
      }
      this.fire("dyw-crosswords-resolved");
    },
    layoutChildren : function(){
      var positions = {};
      var crosswords = this.$.crosswords.getDistributedNodes();

      // init positions
      for(var idx = 0; idx < crosswords.length; idx++)
      {
        var currentCrossword = crosswords[idx];
        positions[currentCrossword.id] = {"x":0,"y":0};
      }

      var crosswordMatchBoxes = this.$.crossmatchboxes.getDistributedNodes();

      // compute positions, link cases
      for(var idx = 0; idx < crosswordMatchBoxes.length; idx++)
      {
        var currentCrossMatchBox = crosswordMatchBoxes[idx];
        var crossword1 = this.querySelector('#'+currentCrossMatchBox.id1);
        var crossword2 = this.querySelector('#'+currentCrossMatchBox.id2);

        if(crossword2.orientation == "horizontal")
        {
          positions[crossword2.id].x = positions[crossword1.id].x - ((currentCrossMatchBox.n2-1)*(this.caseSize+6));
          positions[crossword2.id].y = positions[crossword1.id].y + ((currentCrossMatchBox.n1-1)*(this.caseSize+6));
        }else
        {
          positions[crossword2.id].x = positions[crossword1.id].x + ((currentCrossMatchBox.n1-1)*(this.caseSize+6));
          positions[crossword2.id].y = positions[crossword1.id].y - ((currentCrossMatchBox.n2-1)*(this.caseSize+6));
        }

        var xOffset = Math.abs(Math.min(0, positions[crossword2.id].x));
        var yOffset = Math.abs(Math.min(0, positions[crossword2.id].y));

        // revalue positions ifn
        if(xOffset || yOffset){
          for(var key in positions){
            positions[key].x += xOffset;
            positions[key].y += yOffset;
          }
        }

        var crossCase1 = crossword1.getCase(currentCrossMatchBox.n1);
        var crossCase2 = crossword2.getCase(currentCrossMatchBox.n2);

        crossCase1.linkedCase = crossCase2;
        crossCase2.linkedCase = crossCase1;
      }

      // apply the style
      for(var idx = 0; idx < crosswords.length; idx++)
      {
        var currentCrossword = crosswords[idx];
        currentCrossword.style.left = positions[currentCrossword.id].x+"px";
        currentCrossword.style.top = positions[currentCrossword.id].y+"px";
        currentCrossword.caseSize = this.caseSize;
      }

    },
    pushKey : function(iKey){
      if(this._focusedCrossword)
        this._focusedCrossword.pushKey(iKey);
    },
    popKey : function(iKey){
      if(this._focusedCrossword)
        this._focusedCrossword.popKey();
    }
  });
</script>
