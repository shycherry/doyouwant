<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="./dyw-crossword.html"/>

<dom-module name="dyw-crosswords">
  <style>
    :host{
      display: block;
      overflow: hidden;
      white-space: nowrap;
      position: relative;
      width: 500px;
      height: 500px;
    }
    ::content dyw-crossword {
      color: red;
      position: absolute;
    };
  </style>

  <template>
    <content id="crosswords" select="dyw-crossword"></content>
    <content id="crossmatchboxes" select="dyw-crossmatchbox"></content>
  </template>
</dom-module>

<script>
  Polymer({
    is: "dyw-crosswords",
    behaviors: [Polymer.IronResizableBehavior],
    properties:{
      caseSize : {
        type:Number,
        value: 100
      }
    },
    ready : function(){
      this.layoutChildren = this.layoutChildren.bind(this);

      this.addEventListener("iron-resize", this.layoutChildren);
      this.addEventListener("mouseover", function(ev){
        var currentNode = ev.toElement;
        if(currentNode.nodeName == "DYW-CROSSWORD"){
          currentNode.getFocus();
          this._focusedCrossword = currentNode;
        }
      });
      this.addEventListener("mouseout", function(ev){
        var currentNode = ev.fromElement;
        if(currentNode.nodeName == "DYW-CROSSWORD"){
          currentNode.lostFocus();
          this._focusedCrossword = null;
        }
      });
    },
    layoutChildren : function(){
      var positions = {};
      var crosswords = this.$.crosswords.getDistributedNodes();
      for(var idx = 0; idx < crosswords.length; idx++)
      {
        var currentCrossword = crosswords[idx];
        currentCrossword.caseSize = this.caseSize;
        currentCrossword.style.top = "0px";
        currentCrossword.style.left = "0px";
        positions[currentCrossword.id] = {"x":0,"y":0};
      }

      var crosswordMatchBoxes = this.$.crossmatchboxes.getDistributedNodes();
      for(var idx = 0; idx < crosswordMatchBoxes.length; idx++)
      {
        var currentCrossMatchBox = crosswordMatchBoxes[idx];
        var crossword1 = this.querySelector('#'+currentCrossMatchBox.id1);
        var crossword2 = this.querySelector('#'+currentCrossMatchBox.id2);

        if(crossword2.orientation == "horizontal")
        {
          positions[crossword2.id].x = positions[crossword1.id].x + ((currentCrossMatchBox.n2-1)*(this.caseSize+6));
          crossword2.style.left = positions[crossword2.id].x+"px";

          positions[crossword2.id].y = positions[crossword1.id].y + ((currentCrossMatchBox.n1-1)*(this.caseSize+6));
          crossword2.style.top = positions[crossword2.id].y+"px";
        }else
        {
          positions[crossword2.id].x = positions[crossword1.id].x + ((currentCrossMatchBox.n1-1)*(this.caseSize+6));
          crossword2.style.left = positions[crossword2.id].x+"px";

          positions[crossword2.id].y = positions[crossword1.id].y - ((currentCrossMatchBox.n2-1)*(this.caseSize+6));
          crossword2.style.top = positions[crossword2.id].y+"px";
        }

        var crossCase1 = crossword1.getCase(currentCrossMatchBox.n1);
        var crossCase2 = crossword2.getCase(currentCrossMatchBox.n2);

        crossCase1.linkedCase = crossCase2;
        crossCase2.linkedCase = crossCase1;
      }
    },
    pushKey : function(iKey){
      if(this._focusedCrossword)
        this._focusedCrossword.pushKey(iKey);
    }
  });
</script>
